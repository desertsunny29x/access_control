name: Update Changelog

on:
  pull_request:
    types:
      - closed

permissions:
  contents: write
  pull-requests: read

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update CHANGELOG.md
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_AUTHOR=${{ github.event.pull_request.user.login }}
          BRANCH=${{ github.event.pull_request.head.ref }}
          DATE=$(date -u +"%Y-%m-%d")

          # Initialize changelog if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          NEW_ENTRY="- ðŸŽ‰ **${PR_TITLE}** (#${PR_NUMBER}) by @${PR_AUTHOR} [branch: \`${BRANCH}\`]"

          # If today's date section exists, append entry under it
          if grep -q "## ${DATE}" CHANGELOG.md; then
            # Insert NEW_ENTRY right after the date header line
            awk -v date="## ${DATE}" -v entry="$NEW_ENTRY" '
              {
                print $0
                if ($0 == date) {
                  print entry
                }
              }
            ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          else
            # Prepend new section with today's date and entry after header
            awk -v date="## ${DATE}" -v entry="$NEW_ENTRY" '
              NR==2 {
                print date
                print entry
                print ""
              }
              {print}
            ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          fi

      - name: Commit and push changes
        run: |
          git add CHANGELOG.md
          git commit -m "docs: update changelog for PR #${{ github.event.pull_request.number }}"
          git push origin HEAD:${{ github.ref_name }}
