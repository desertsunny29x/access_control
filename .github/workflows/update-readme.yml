name: Update README with PR Info

on:
  pull_request:
    types: [closed]

jobs:
  update-readme:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract PR details
        run: |
          echo "- [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}) — **${{ github.event.pull_request.title }}** by @${{ github.event.pull_request.user.login }} on $(date +'%Y-%m-%d')" >> pr_entry.md

      - name: Insert PR entry into README
        run: |
          # Insert PR entry under "Recent Pull Requests" section
          awk '/## 📦 Recent Pull Requests/{print; system("cat pr_entry.md"); next}1' README.md > temp.md
          mv temp.md README.md

      - name: Ensure top section is present
        run: |
          echo "# JetBlue dbt Access Control" > top.md
          echo "" >> top.md
          echo "✈️ **Purpose**" >> top.md
          echo "This repository manages access control within JetBlue's dbt environment. It defines and applies role-based permissions across various schemas and environments, ensuring secure and auditable data access." >> top.md
          echo "" >> top.md
          echo "## 🧩 Macro Descriptions" >> top.md
          echo "| Macro File | Description |" >> top.md
          echo "|------------|-------------|" >> top.md
          echo "| \`create_byod_roles.sql\` | Creates external-facing roles for BYOD (Bring Your Own Data) scenarios, enabling controlled access to user-owned datasets. |" >> top.md
          echo "| \`create_database_roles.sql\` | Establishes foundational database roles across environments, serving as the base layer for all access control logic. |" >> top.md
          echo "| \`create_raw_roles.sql\` | Grants read-only access to raw data schemas, typically used for ingestion validation and audit purposes. |" >> top.md
          echo "| \`create_sensitive_roles.sql\` | Defines roles with access to sensitive datasets, ensuring proper segregation and compliance. |" >> top.md
          echo "| \`create_sensitive_roles_with_masking_policies.sql\` | Enhances sensitive role definitions by applying masking policies for fields requiring obfuscation. |" >> top.md
          echo "| \`grant_core_roles.sql\` | Applies grants to core roles that span multiple domains, such as analytics, engineering, or operations. |" >> top.md
          echo "| \`grant_functional_roles.sql\` | Assigns permissions to business-specific functional roles, aligning access with operational responsibilities. |" >> top.md
          echo "| \`run_grants.sql\` | Orchestrates the execution of all grant macros, ensuring consistent and complete role-based access deployment. |" >> top.md
          echo "" >> top.md

          # Combine top section with updated README
          cat top.md README.md > final.md
          mv final.md README.md

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "📘 Update README with merged PR #${{ github.event.pull_request.number }}"
          git push
